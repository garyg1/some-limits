<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<title>Building a fast spline editor with HTML5</title>
<link rel="stylesheet" href="/some-limits/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://garygurlaskie.com/some-limits/feed.xml" title="Gary Gurlaskie" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Gary Gurlaskie</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Building a fast spline editor with HTML5</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2018-04-11T21:50:54-04:00" itemprop="datePublished">Apr 11, 2018
      </time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">garyg1</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>This is a write-up for a thing I made.</p>

<p>You can check it out <a href="http://garygurlaskie.com/some-limits/splines.html">here</a>.</p>

<h2 id="cubic-splines">Cubic splines</h2>

<p>If you already know what a cubic spline is, there’s nothing new in this section.</p>
<h3 id="definition">Definition</h3>

<p>Given points \( (t_0, x_0), (t_1, x_1), …, (t_n, x_n) \), a <strong>cubic spline</strong>  is a piecewise cubic polynomial \( f(t) \) that passes through each \( (t_i, x_i) \) pair, and has the property that \( f \), \( f’ \), and \( f^{\prime\prime} \) are continuous on \( [t_0, t_n] \).</p>

<h3 id="uniqueness">Uniqueness</h3>
<p>For any set of points, there are many different cubic splines that interpolate them.</p>

<p>Cubic splines have \( 4n \) coefficients, but there are only \( 4n - 2 \) constraints on their coefficients. We will impose two more constraints, and then we can uniquely define a “natural” cubic spline from the control points.</p>

<h3 id="natural-splines">Natural Splines</h3>

<p>A <strong>natural cubic spline</strong> is a cubic spline that also satisfies the condition that \( f^{\prime\prime}(t_1) = f^{\prime\prime}(t_n) = 0 \).</p>

<h2 id="implementation">Implementation</h2>

<h3 id="parametric-splines">Parametric Splines</h3>

<p><strong>The problem:</strong> Given a set of points \( r_0 = (x_0, y_0), r_1 = (x_1, y_1), … , r_n = (x_n, y_n) \), we want to construct a spline that interpolates them <em>in order</em>.</p>

<p>We can’t do this with splines in a single dimension. So we parameterize, and consider a parametric function \( f(t) = (x(t), y(t)) \) that interpolates \( (0, r_0), (1, r_1), … , (n, r_n) \). You can show that if \( x(t) \) and \( y(t) \) are splines for \( \{(i, x_i)\} \) and \( \{(i, y_i)\} \), then \( f(t) \) will be a spline for \( \{(i, r_i)\} \).</p>

<h3 id="finding-the-closest-spline-segment-to-a-point">Finding the closest spline segment to a point</h3>

<p><strong>The problem:</strong> Given a point \( (x, y) \) and a parametric cubic spline \( f(t) = (x(t), y(t))\), find the segment of the spline \( (x, y) \) is closest to.</p>

<p>Since splines are continuous, we can just apply basic optimization techniques:</p>

<ol>
  <li>For each spline segment \( f_i \), find the critical points of the distance \( D_i(t) \).</li>
  <li>The critical point \(s\) with the smallest \( D_i(s) \) is the absolute minimum for this spline.</li>
  <li>Choose the spline segment with the smallest minimum distance.</li>
</ol>

<p>But we run into a problem: the squared distance from a cubic function to a point is a sixth degree polynomial, so the derivative is a fifth degree polynomial. There is no explicit formula!</p>

<p>We must choose an iterative method to find the roots. An simple and interesting one is called Durand-Kerner, which finds all five roots simultaneously. Some of the roots will be complex numbers.</p>

<h4 id="the-durand-kerner-method">The Durand-Kerner method</h4>

<p>The method comes from the observation that</p>

<script type="math/tex; mode=display">P(x) = (x - r_1)(x - r_2)(x - r_3)(x - r_4)(x - r_5)</script>

<p>implies</p>

<script type="math/tex; mode=display">r_1 = x + \frac {P(x)} {(x - r_2)(x - r_3)(x - r_4)(x - r_5)}</script>

<p>Then, we perform a fixed point iteration to solve for all five roots simultaneously. We choose initial values \( a_0, b_0,…, e_0 \in C \). Then we compute</p>

<script type="math/tex; mode=display">a_{i + 1} = a_i + \frac {P(a_i)} {(a_i - b_i)(a_i - c_i)(a_i - d_i)(a_i - e_i)}</script>

<script type="math/tex; mode=display">b_{i + 1} = b_i + \frac {P(b_i)} {(b_i - a_i)(b_i - c_i)(b_i - d_i)(b_i - e_i)}</script>

<script type="math/tex; mode=display">...</script>

<script type="math/tex; mode=display">e_{i + 1} = e_i + \frac {P(e_i)} {(e_i - a_i)(e_i - b_i)(e_i - c_i)(e_i - d_i)}</script>

<p>until \( |a_{i+1} - a_i| &lt; \epsilon \), \( |b_{i+1} - b_i| &lt; \epsilon \), \(…\), and \( |e_{i+1} - e_i| &lt; \epsilon \) for some tolerance \( \epsilon \).</p>

<p>The <a href="https://en.wikipedia.org/wiki/Durand%E2%80%93Kerner_method">Wikipedia article</a> is a pretty good read.</p>

<h4 id="other-methods">Other methods</h4>

<p>I read an <a href="http://homepage.divms.uiowa.edu/~atkinson/ftp/CurvesAndSufacesClosestPoint.pdf">interesting paper</a> about using an ensemble method to solve this problem. The authors were using cubic splines to model roads for a driving simulator, and wanted to know where the vehicle was on the road given the \((x, y, z) \) coordinates.</p>

<h3 id="drawing-the-curve">Drawing the curve</h3>

<p><strong>The problem:</strong> Graph a cubic spline continuously on a grid of pixels.</p>

<p>In other words, we want to find \( 0 = t_1 &lt; t_2 &lt; … &lt; t_{k-1} &lt; t_k = 1\) such that, if we plot the points \( f(t_1), f(t_2), …, f(t_k) \) as 1x1 squares, the squares will be connected.</p>

<p><strong>My Solution:</strong> We will use an adaptive algorithm to find the \( t_i \).</p>

<p>Let’s impose an additional restriction – if we have for all \( 1 \le t \le k \) that</p>

<script type="math/tex; mode=display">\max(|x(t_{i+1}) - x(t_i)|, |y(t_{i+1}) - y(t_i)|) = 1</script>

<p>then our set of squares will certainly be adjacent.</p>

<p>Let’s approximate</p>

<script type="math/tex; mode=display">x(t_{i+1}) \approx x(t_i) + x'(t_i) (t_{i+1} - t_i)</script>

<p>so we have that</p>

<script type="math/tex; mode=display">1 \approx |x'(t_i) (t_{i+1} - t_i)|</script>

<p>and</p>

<script type="math/tex; mode=display">t_{i+1} \approx t_1 + \frac {1}{|x'(t_i)|}</script>

<p>and by the same argument for \( y(t) \), we have</p>

<script type="math/tex; mode=display">t_{i+1} \approx t_1 + \min(\frac {1}{|x'(t_i)|}, \frac{1}{|y'(t_i)|})</script>

<p>This is exactly how I pick my points to graph.</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">let</span> <span class="nx">dt</span><span class="p">:</span> <span class="nx">number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">t</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">t</span> <span class="o">+=</span> <span class="nx">dt</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// evaulate x(t), y(t), x'(t), y'(t)...</span>
    
    <span class="c1">// update t using adaptive algorithm</span>
    <span class="nx">dt</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">dx</span><span class="p">),</span> <span class="mi">1</span> <span class="o">/</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">dy</span><span class="p">));</span>

    <span class="c1">// plot the point</span>
    <span class="nx">putPixel</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">color</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>This is fast enough to be smooth on my Nexus 5, and looks pretty good.</p>

<h2 id="conclusion">Conclusion</h2>

<p>I had a lot of fun building this, and I got to learn about a simultaneous root-finding algorithm and I got to figure out a decent way to do adaptive polynomial graphing. If you have any comments or think I could have done it better, <a href="mailto:garygurlaskie@gmail.com">I’d love to hear</a>.</p>

  </div><a class="u-url" href="/some-limits/2018/04/11/How-It-Works.html" hidden></a>
</article>

      </div>
    </main>
</body>

</html>
